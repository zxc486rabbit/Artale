<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>Artale Boss é »é“å·¡é‚</title>
  <style>
    body { font-family: "Segoe UI", sans-serif; background: #f1f3f5; padding: 20px; }
    h1 { text-align: center; }
    input, select, button { padding: 6px 10px; font-size: 1rem; margin: 5px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; background: #fff; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; font-size: 0.9rem; }
    .soon { background: #fff3cd; }
    .yes { background: #28a745; color: white; }
    .no { background: #dc3545; color: white; }
    .reset { background: #6c757d; color: white; }
    .status-âœ… { background: #d4edda; }
    .status-âŒ { background: #f8d7da; }
    .status-æœªè¨˜éŒ„ { background: #e2e3e5; }
  </style>
</head>
<body>
  <h1>ğŸ›¡ï¸ Artale Boss é »é“å·¡é‚ç³»çµ±</h1>

  <div style="text-align:center;">
    <label>
      ğŸ™‹â€â™‚ï¸ è¨˜éŒ„è€…ï¼š<input id="reporter" placeholder="è¼¸å…¥ä½ çš„æš±ç¨±" />
    </label>
    <select id="bossSelect">
      <option value="mushroom">ğŸ„ è‡è‡ç‹</option>
      <option value="witch">â„ï¸ é›ªå±±é­”å¥³</option>
      <option value="bookman">ğŸ“œ æ›¸ç”Ÿå¹½éˆ</option>
    </select>
    <input type="text" id="searchInput" placeholder="æœå°‹é »é“ï¼Œå¦‚ 555" />
  </div>

  <table>
    <thead>
      <tr>
        <th>é »é“</th>
        <th>ç‹€æ…‹</th>
        <th>ä¸Šæ¬¡ç´€éŒ„</th>
        <th>ä¸‹æ¬¡åˆ·æ–°å€é–“</th>
        <th>å‰©é¤˜æ™‚é–“</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody id="channelTable"></tbody>
  </table>

  <hr>
  <h2>ğŸ“‹ å…¨éƒ¨å›å ±ç´€éŒ„ï¼ˆä¾†è‡ª Google Sheetï¼‰</h2>
  <div style="text-align:right;">
    ğŸ”æœå°‹ï¼š<input type="text" id="logFilter" placeholder="é »é“ / å›å ±è€… / ç‹€æ…‹...">
  </div>
  <table>
    <thead>
      <tr>
        <th>Boss</th>
        <th>é »é“</th>
        <th>ç‹€æ…‹</th>
        <th>æ™‚é–“</th>
        <th>å›å ±è€…</th>
      </tr>
    </thead>
    <tbody id="sheetLog"></tbody>
  </table>

  <audio id="pingSound" src="https://freesound.org/data/previews/341/341695_5260877-lq.mp3"></audio>

  <script>
    const SHEET_API = "https://script.google.com/macros/s/AKfycbxnO4TJaTneo9knUkg-6qECUA9hRHUbSEoiWlYsz5beesGL6SBk8hLpoUHn2oobGD-W/exec";
    const webhookURL = "https://discord.com/api/webhooks/1387388993204654242/ODt2PR68hxjnpCiMpMnfRa2X1BmhSLB2tJFibRBsZjftVAYZCoA17UDNoJ4DBG65HOca";
    const bossSettings = {
      mushroom: { min: 60 * 60 * 1000, max: 90 * 60 * 1000 },
      witch: { min: 3 * 60 * 60 * 1000, max: 5 * 60 * 60 * 1000 },
      bookman: { min: 2.5 * 60 * 60 * 1000, max: 5 * 60 * 60 * 1000 },
    };

    let latestData = {};

    const format = ts => new Date(ts).toLocaleTimeString("zh-TW", { hour: "2-digit", minute: "2-digit" });
    const timeLeft = (ts, boss) => {
      const max = bossSettings[boss].max;
      const left = ts + max - Date.now();
      return left > 0 ? `${Math.floor(left / 60000)} åˆ†` : "å·²é";
    };
    const range = (ts, boss) => {
      const { min, max } = bossSettings[boss];
      return `${format(ts + min)} ~ ${format(ts + max)}`;
    };

    async function loadSheetLog() {
      const res = await fetch(SHEET_API);
      const data = await res.json();
      const tbody = document.getElementById("sheetLog");
      const keyword = document.getElementById("logFilter").value.toLowerCase();
      tbody.innerHTML = "";
      const sorted = data.sort((a, b) => new Date(b.æ™‚é–“) - new Date(a.æ™‚é–“));
      latestData = {};
      sorted.forEach(row => {
        const chKey = row.é »é“;
        const boss = row.Boss;
        if (!latestData[boss]) latestData[boss] = {};
        if (!latestData[boss][chKey]) {
          latestData[boss][chKey] = {
            status: row.ç‹€æ…‹,
            time: new Date(row.æ™‚é–“).getTime(),
            reporter: row.å›å ±è€…
          };
        }
        const match = !keyword || Object.values(row).some(v => v.toLowerCase?.().includes(keyword));
        if (!match) return;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.Boss}</td>
          <td>${row.é »é“}</td>
          <td>${row.ç‹€æ…‹}</td>
          <td>${new Date(row.æ™‚é–“).toLocaleString("zh-TW")}</td>
          <td>${row.å›å ±è€… || '-'}</td>`;
        tbody.appendChild(tr);
      });
      drawTable();
    }

    function update(chKey, action) {
      const boss = document.getElementById("bossSelect").value;
      const bossText = document.getElementById("bossSelect").selectedOptions[0].text;
      const reporter = document.getElementById("reporter").value.trim();
      fetch(SHEET_API, {
        method: "POST",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          boss: bossText,
          channel: chKey,
          status: action === 'yes' ? 'âœ…' : action === 'no' ? 'âŒ' : 'æœªè¨˜éŒ„',
          reporter
        })
      }).then(loadSheetLog);
    }

    function drawTable() {
      const table = document.getElementById("channelTable");
      table.innerHTML = "";
      const boss = document.getElementById("bossSelect").value;
      const now = Date.now();
      const setting = bossSettings[boss];
      const keyword = document.getElementById("searchInput").value.trim();
      let list = [];
      if (keyword) {
        const ch = parseInt(keyword);
        if (!isNaN(ch) && ch >= 1 && ch <= 4000) list.push(ch);
      } else {
        for (let i = 1; i <= 100; i++) list.push(i);
      }
      list.forEach(i => {
        const chKey = `CH${i}`;
        const record = latestData[boss]?.[chKey];
        const tr = document.createElement("tr");
        if (record?.time) {
          const elapsed = now - record.time;
          if (elapsed >= setting.min && elapsed <= setting.max) tr.classList.add("soon");
        }
        const statusClass = `status-${record?.status || 'æœªè¨˜éŒ„'}`;
        tr.classList.add(statusClass);
        tr.innerHTML = `
          <td>${chKey}</td>
          <td>${record?.status || "æœªè¨˜éŒ„"}</td>
          <td>${record?.time ? format(record.time) : "-"}</td>
          <td>${record?.time ? range(record.time, boss) : "-"}</td>
          <td>${record?.time ? timeLeft(record.time, boss) : "-"}</td>
          <td>
            <button class="yes" onclick="update('${chKey}', 'yes')">âœ…</button>
            <button class="no" onclick="update('${chKey}', 'no')">âŒ</button>
            <button class="reset" onclick="update('${chKey}', 'reset')">ğŸ—‘</button>
          </td>`;
        table.appendChild(tr);
      });
    }

    document.getElementById("logFilter").addEventListener("input", loadSheetLog);
    document.getElementById("bossSelect").addEventListener("change", drawTable);
    document.getElementById("searchInput").addEventListener("input", drawTable);
    document.getElementById("reporter").value = localStorage.getItem("reporter") || "";
    document.getElementById("reporter").addEventListener("input", e => localStorage.setItem("reporter", e.target.value));
    loadSheetLog();
    setInterval(loadSheetLog, 30000);
  </script>
</body>
</html>