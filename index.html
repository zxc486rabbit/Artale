<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>Artale Boss é »é“å·¡é‚</title>
  <style>
    body { font-family: "Segoe UI", sans-serif; background: #f1f3f5; padding: 20px; }
    h1 { text-align: center; }
    input, select, button { padding: 6px 10px; font-size: 1rem; margin: 5px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; background: #fff; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; font-size: 0.9rem; }
    .soon { background: #fff3cd; }
    .yes { background: #28a745; color: white; }
    .no { background: #dc3545; color: white; }
    .reset { background: #6c757d; color: white; }
    .status-âœ… { background: #d4edda; }
    .status-âŒ { background: #f8d7da; }
    .status-æœªè¨˜éŒ„ { background: #e2e3e5; }
  </style>
</head>
<body>
  <h1>ğŸ›¡ï¸ Artale Boss é »é“å·¡é‚ç³»çµ±</h1>
<button onclick="localStorage.clear(); location.reload();">ğŸ” å…¨éƒ¨é‡æ–°è¼‰å…¥</button>
  <div style="text-align:center;">
    <label>
      ğŸ™‹â€â™‚ï¸ è¨˜éŒ„è€…ï¼š<input id="reporter" placeholder="è¼¸å…¥ä½ çš„æš±ç¨±" />
    </label>
    <select id="bossSelect">
      <option value="mushroom">ğŸ„ è‡è‡ç‹</option>
      <option value="witch">â„ï¸ é›ªå±±é­”å¥³</option>
      <option value="bookman">ğŸ“œ æ›¸ç”Ÿå¹½éˆ</option>
    </select>
    <input type="text" id="searchInput" placeholder="æœå°‹é »é“ï¼Œå¦‚ 555" />
  </div>

  <table>
    <thead>
      <tr>
        <th>é »é“</th>
        <th>ç‹€æ…‹</th>
        <th>ä¸Šæ¬¡ç´€éŒ„</th>
        <th>ä¸‹æ¬¡åˆ·æ–°å€é–“</th>
        <th>å‰©é¤˜æ™‚é–“</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody id="channelTable"></tbody>
  </table>

  <hr>
  <h2>ğŸ“‹ å…¨éƒ¨å›å ±ç´€éŒ„ï¼ˆä¾†è‡ª Google Sheetï¼‰</h2>
  <div style="text-align:right;">
    ğŸ”æœå°‹ï¼š<input type="text" id="logFilter" placeholder="é »é“ / å›å ±è€… / ç‹€æ…‹...">
  </div>
  <table>
    <thead>
      <tr>
        <th>Boss</th>
        <th>é »é“</th>
        <th>ç‹€æ…‹</th>
        <th>æ™‚é–“</th>
        <th>å›å ±è€…</th>
      </tr>
    </thead>
    <tbody id="sheetLog"></tbody>
  </table>

  <audio id="pingSound" src="https://freesound.org/data/previews/341/341695_5260877-lq.mp3"></audio>

  <script>
    const SHEET_API = "https://script.google.com/macros/s/AKfycbyd-ozk9faY-IThiYJEo7-OwJS0P6d8fIzh98ELO9qos15LETfEdz95qemJH8m2twos/exec";
    const webhookURL = "https://discord.com/api/webhooks/1387388993204654242/ODt2PR68hxjnpCiMpMnfRa2X1BmhSLB2tJFibRBsZjftVAYZCoA17UDNoJ4DBG65HOca";
    const bossSettings = {
      mushroom: { min: 60 * 60 * 1000, max: 90 * 60 * 1000 },
      witch: { min: 3 * 60 * 60 * 1000, max: 5 * 60 * 60 * 1000 },
      bookman: { min: 2.5 * 60 * 60 * 1000, max: 5 * 60 * 60 * 1000 },
    };

    const startCH = 1, endCH = 4000, perPage = 100;
    const bossSelect = document.getElementById("bossSelect");
    const sound = document.getElementById("pingSound");
    const getKey = () => `boss_${bossSelect.value}_data`;
    const format = ts => new Date(ts).toLocaleTimeString("zh-TW", { hour: "2-digit", minute: "2-digit" });
    const timeLeft = (ts, boss) => {
      const max = bossSettings[boss].max;
      const left = ts + max - Date.now();
      return left > 0 ? `${Math.floor(left / 60000)} åˆ†` : "å·²é";
    };
    const range = (ts, boss) => {
      const { min, max } = bossSettings[boss];
      return `${format(ts + min)} ~ ${format(ts + max)}`;
    }

    const load = () => JSON.parse(localStorage.getItem(getKey()) || '{}');
    const save = (obj) => localStorage.setItem(getKey(), JSON.stringify(obj));

    function notifyDiscord(chKey, bossName) {
      fetch(webhookURL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ content: `ğŸ“£ Boss æé†’ï¼\nâœ… [${bossName}] é »é“ ${chKey} é€²å…¥åˆ·æ–°å€é–“ï¼Œè«‹ç›¡å¿«æŸ¥çœ‹ï¼` })
      });
    }

    function update(chKey, action) {
      const reporter = document.getElementById("reporter").value.trim();
      const data = load();
      if (action === 'reset') delete data[chKey];
      else data[chKey] = { status: action === 'yes' ? 'âœ…' : 'âŒ', time: Date.now(), notified: false };
      save(data);
      fetch(SHEET_API, {
  method: "POST",
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    boss: bossSelect.options[bossSelect.selectedIndex].text,
    channel: chKey,
    status: data[chKey]?.status || 'æœªè¨˜éŒ„',
    reporter
  })
})
.then(res => res.text())
.then(txt => console.log("ğŸ“¤ å›å‚³æˆåŠŸï¼š", txt))
.catch(err => console.error("âŒ ä¸Šå‚³å¤±æ•—ï¼š", err));
      drawTable();
      loadSheetLog();
    }

    function drawTable() {
      const table = document.getElementById("channelTable");
      table.innerHTML = "";
      const data = load();
      const boss = bossSelect.value;
      const now = Date.now();
      const setting = bossSettings[boss];
      const bossName = bossSelect.options[bossSelect.selectedIndex].text;
      const keyword = document.getElementById("searchInput").value.trim();
      let list = [];
      if (keyword) {
        const ch = parseInt(keyword);
        if (!isNaN(ch) && ch >= startCH && ch <= endCH) list.push(ch);
      } else {
        const start = 1;
        for (let i = start; i <= start + perPage; i++) list.push(i);
      }
      list.forEach(i => {
        const chKey = `CH${i}`;
        const record = data[chKey];
        const tr = document.createElement("tr");
        if (record && record.time) {
          const elapsed = now - record.time;
          if (elapsed >= setting.min && elapsed <= setting.max) {
            tr.classList.add("soon");
            if (!record.notified) {
              sound.play().catch(() => {});
              notifyDiscord(chKey, bossName);
              record.notified = true;
              save(data);
            }
          }
        }
        const statusClass = `status-${record?.status || 'æœªè¨˜éŒ„'}`;
        tr.classList.add(statusClass);
        tr.innerHTML = `
          <td>${chKey}</td>
          <td>${record?.status || "æœªè¨˜éŒ„"}</td>
          <td>${record?.time ? format(record.time) : "-"}</td>
          <td>${record?.time ? range(record.time, boss) : "-"}</td>
          <td>${record?.time ? timeLeft(record.time, boss) : "-"}</td>
          <td>
            <button class="yes" onclick="update('${chKey}', 'yes')">âœ…</button>
            <button class="no" onclick="update('${chKey}', 'no')">âŒ</button>
            <button class="reset" onclick="update('${chKey}', 'reset')">ğŸ—‘</button>
          </td>`;
        table.appendChild(tr);
      });
    }

    async function loadSheetLog() {
      const res = await fetch(SHEET_API);
      const data = await res.json();
      const tbody = document.getElementById("sheetLog");
      const keyword = document.getElementById("logFilter").value.toLowerCase();
      tbody.innerHTML = "";
      const sorted = data.sort((a, b) => new Date(b.æ™‚é–“) - new Date(a.æ™‚é–“));
      sorted.forEach(row => {
        const match = !keyword || Object.values(row).some(v => v.toLowerCase?.().includes(keyword));
        if (!match) return;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.Boss}</td>
          <td>${row.é »é“}</td>
          <td>${row.ç‹€æ…‹}</td>
          <td>${new Date(row.æ™‚é–“).toLocaleString("zh-TW")}</td>
          <td>${row.å›å ±è€… || '-'}</td>`;
        tbody.appendChild(tr);
      });
    }

    bossSelect.addEventListener("change", drawTable);
    document.getElementById("searchInput").addEventListener("input", drawTable);
    document.getElementById("logFilter").addEventListener("input", loadSheetLog);
    document.getElementById("reporter").value = localStorage.getItem("reporter") || "";
    document.getElementById("reporter").addEventListener("input", e => localStorage.setItem("reporter", e.target.value));
    drawTable();
    loadSheetLog();
    setInterval(() => { drawTable(); loadSheetLog(); }, 30000);
  </script>
</body>
</html>